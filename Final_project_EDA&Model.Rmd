---
title: "final project_EDA and Model"
author: "Alice Liao, Revo Tesha, Salvador, Cindy, Evelyn "
date: "12/1/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readr)
library(cowplot)
library(janitor)
library(nnet)
library(caret)
library(broom)
library(tree)
library(brms)
set.seed(10)
```

## Exploratory Data Analysis for oh_wv_2012 Dataset

### Training data
```{r}
oh_wv_2012 <- read.csv("data/oh_wv_2012.csv", header = TRUE)
train = sample(max(dim(oh_wv_2012)), max(dim(oh_wv_2012))*0.75) # 75% training
train_oh_wv_2012 = oh_wv_2012[train,]
test_oh_wv_2012 = oh_wv_2012[-train,]
```

### Distribution of Variables (and possible transformations):
```{r}
summary(train_oh_wv_2012)
```

```{r}
# death rate - numerical
death_rate_p = ggplot(train_oh_wv_2012, aes(x = imput_est_death_rate_num)) +
  geom_histogram() +
  labs(x = "Estimated death rate")

tdeath_rate_p = ggplot(train_oh_wv_2012, aes(x = log(imput_est_death_rate_num))) +
  geom_histogram() +
  labs(x = "Estimated death rate")

plot_grid(death_rate_p,tdeath_rate_p)
```


```{r}
# hydrocodone -- log transformation
hyd_wt_p = ggplot(train_oh_wv_2012, aes(x = hyd_wt)) +
  geom_histogram() +
  labs(x = "Total Active Weight for Hydrocodone")
thyd_wt_p = ggplot(train_oh_wv_2012, aes(x = log(hyd_wt))) +
  geom_histogram() +
  labs(x = "Log Total Active Weight for Hydrocodone")
plot_grid(hyd_wt_p, thyd_wt_p)

# % hydrocodone 
hyd_perc_p = ggplot(train_oh_wv_2012, aes(perc_hyd))+
  geom_histogram()
thyd_perc_p = ggplot(train_oh_wv_2012, aes(log(perc_hyd)))+
  geom_histogram()
plot_grid(hyd_perc_p, thyd_perc_p)
```

```{r}
# oxycodone -- log transformation
oxy_wt_p = ggplot(train_oh_wv_2012, aes(x = oxy_wt)) +
  geom_histogram() +
  labs(x = "Total Active Weight for Oxycodone")
toxy_wt_p = ggplot(train_oh_wv_2012, aes(x = log(oxy_wt))) +
  geom_histogram() +
  labs(x = "Log Total Active Weight for Oxycodone")
plot_grid(oxy_wt_p, toxy_wt_p)

# % oxycodone
oxy_perc_p = ggplot(train_oh_wv_2012, aes(perc_oxy))+
  geom_histogram()
toxy_perc_p = ggplot(train_oh_wv_2012, aes(log(perc_oxy)))+
  geom_histogram()
plot_grid(oxy_perc_p, toxy_perc_p)
```

```{r}
# number of distributors per 10,000 in a county -- no log transformation necessary
ndptt_p = ggplot(train_oh_wv_2012, aes(x = distr_num_ptt)) +
  geom_histogram() +
  labs(x = "Number of Distributors per 10,000 in a County")
tndptt_p = ggplot(train_oh_wv_2012, aes(x = log(distr_num_ptt))) +
  geom_histogram() +
  labs(x = "Log Number of Distributors per 10,000 in a County")
plot_grid(ndptt_p, tndptt_p)
```

```{r}
# number of pharmacies per 10,000 for a county -- no transformation necessary
nptt_p = ggplot(train_oh_wv_2012, aes(x = pharmacy_num_ptt)) +
  geom_histogram() +
  labs(x = "Number of Pharmacies per 10,000 in a County")
nptt_p
```

```{r}
# distribution of median income - need log transformation
med_income = ggplot(train_oh_wv_2012, aes(x = median_income)) +
  geom_histogram() +
  labs(x = "Median income")
log_med_income = ggplot(train_oh_wv_2012, aes(x = log(median_income))) +
  geom_histogram() +
  labs(x = "Log median income")
plot_grid(med_income, log_med_income)
```

```{r}
# active drug weight per person in a county -- no log transformation necessary
actwt_pp_plot = ggplot(train_oh_wv_2012, aes(x = act_wt_person_county)) +
  geom_histogram() +
  labs(x = "active weight per person")
log_actwt_pp_plot = ggplot(train_oh_wv_2012, aes(x = log(act_wt_person_county))) +
  geom_histogram() +
  labs(x = "Log active weight per person")
plot_grid(actwt_pp_plot, log_actwt_pp_plot)
```

### Predictors vs. Response:

#### Responses: Death Rate Category
```{r}
ggplot(data = train_oh_wv_2012, aes(x = est_death_rate_cat, y = Population)) + 
  geom_boxplot()+ 
  labs(x = "Estimated Death Rate Category", ylab = "County Population",
        main = "Death Rate Category vs County Population") 

ggplot(data = train_oh_wv_2012, aes(x = est_death_rate_cat, y = pharmacy_num_ptt)) + 
  geom_boxplot() + 
  labs(x = "Estimated Death Rate Category", 
       y = "Number of Pharmacies", 
       main = "Death Rate Category vs Number of Pharmacies per 10,000 Population") 

ggplot(data = train_oh_wv_2012, aes(x = est_death_rate_cat, y = distr_num_ptt)) +
  geom_boxplot() +
  labs(x = "Death Rate Category", y = "Number of manufacturers involved",
       title = "County death rate vs Number of Manufacturers")

#####################################################################################
ggplot(data = train_oh_wv_2012, aes(x = all_active_wt, y = est_death_rate_cat)) + 
  geom_boxplot() + xlab("Active weight total") + ylab("Estimated Death Rate Category") 

train_oh_wv_2012 %>%
  ggplot(aes(x = most_dist_channel, y = est_death_rate_cat)) + geom_boxplot() + xlab("Most Distributed Channel") + ylab("Estimated Death Rate Category") 
  
```

#### Response: Median Income - IGNORE THIS MODEL FIRST

```{r eval=FALSE}
oh_wv_2012 %>%
  ggplot(mapping = aes(x = Political.affiliation, y = median_income)) + geom_boxplot() + xlab("Political Affiliation") + ylab("Median Income")

oh_wv_2012 %>%
  ggplot(mapping = aes(x = dominance, y = median_income)) + geom_boxplot() + xlab("Dominance") + ylab("Median Income")


oh_wv_2012 %>%
  ggplot(mapping = aes(x = all_active_wt , y = median_income)) + geom_point()  + xlab("All Active Weight") + ylab("Median Income")

med_inc_mod3 <- lm(median_income ~ all_active_wt, data = oh_wv_2012)
plot(med_inc_mod3)


oh_wv_2012 %>%
  ggplot(mapping = aes(x = most_dist_channel , y = median_income)) +  geom_boxplot()  + xlab(" Most Distributed Channel") + ylab("Median Income")

oh_wv_2012 %>%
  ggplot(mapping = aes(x = pharmacy_num , y = median_income)) + geom_point()  + xlab("Number of Pharamacies") + ylab("Median Income")

med_inc_mod6 <- lm(median_income ~ pharmacy_num, data = oh_wv_2012)
plot(med_inc_mod6)


oh_wv_2012 %>%
  ggplot(mapping = aes(x = Population , y = median_income)) + geom_point()  + xlab("Population") + ylab("Median Income")

med_inc_mod7 <- lm(median_income ~ Population, data = oh_wv_2012)
plot(med_inc_mod7)

```

### Plot predictors against each other (Interactions)
```{r}
# number of manufactueres (ptt) vs death rate by number of pharmacies (ptt)
ggplot(train_oh_wv_2012,
       aes(x = distr_num_ptt, y = as.numeric(est_death_rate_cat), color = pharmacy_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Number of Distributors per 10,000 People vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Number of Distributors per 10,000 People",
       y = "Estimated Death Rate Category",
       color = "Number of Pharmacies \nper 10,000 People")
ggplot(train_oh_wv_2012,
       aes(x = distr_num_ptt, y = pharmacy_num_ptt))+
  geom_point()

# % oxycodone vs death rate by number of pharmacies (ptt)
ggplot(train_oh_wv_2012,
       aes(x = perc_oxy, y = as.numeric(est_death_rate_cat), color = pharmacy_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Percentage Oxycodone vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Percentage Oxycodone",
       y = "Estimated Death Rate Category",
       color = "Number of Pharmacies \nper 10,000 People")

ggplot(train_oh_wv_2012,
       aes(x = perc_oxy, y = pharmacy_num_ptt))+
  geom_point()

# % oxycodone vs death rate by number of manufacturers
ggplot(train_oh_wv_2012,
       aes(x = perc_oxy, y = as.numeric(est_death_rate_cat), color = distr_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Percentage Oxycodone vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Percentage Oxycodone",
       y = "Estimated Death Rate Category",
       color = "Number of Drug Manufacturers")

ggplot(train_oh_wv_2012,
       aes(x = perc_oxy, y = distr_num_ptt))+
  geom_point()

# active weight per person vs number of pharmacies
ggplot(train_oh_wv_2012,
       aes(x = act_wt_person_county, y = as.numeric(est_death_rate_cat), color = pharmacy_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Active Weight vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Active weight per person",
       y = "Estimated Death Rate Category",
       color = "Number of Pharmacies \nper 10,000 People")
  

# number of manufacturers vs active weight per person
ggplot(train_oh_wv_2012,
       aes(x = act_wt_person_county, y = as.numeric(est_death_rate_cat), color = distr_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Active Weight vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Active weight per person",
       y = "Estimated Death Rate Category",
       color = "Number of Drug Manufacturers")

ggplot(train_oh_wv_2012,
       aes(x = act_wt_person_county, y = distr_num_ptt))+
  geom_point()

# income vs number of pharmacies
ggplot(train_oh_wv_2012,
       aes(x = median_income, y = as.numeric(est_death_rate_cat), color = pharmacy_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Median Income vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Median Income",
       y = "Estimated Death Rate Category",
       color = "Number of Pharmacies")
  
```


```{r}
# interaction b/w median income and political affiliation
ggplot(data = train_oh_wv_2012, 
            aes(x = median_income ,y = as.numeric(est_death_rate_cat),color = political_aff)) +
  geom_point()+
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Median Income vs Death Rate",
       x = "Median Income", y = "Death Rate (Categorical)",
       color = "Political Affiliation")
# Interaction b/w number of pharmacies and political affliation 
ggplot(data=train_oh_wv_2012, 
       aes(x= pharmacy_num_ptt ,y = as.numeric(est_death_rate_cat), color= political_aff)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Number of Pharmacies per 10,000 People vs Death Rate", 
       x = "Number of Pharmacies per 10,000 People", y = "Death Rate (Categorical)",
       color = "Political Affiliation")
# Interaction b/w % oxycodone and political affliation 
ggplot(data=train_oh_wv_2012, 
             aes(x = perc_oxy,y = as.numeric(est_death_rate_cat), color= political_aff)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Percentage Oxycodone vs Death Rate", 
       x = "Percentage Oxycodone", y= "Death Rate (Categorical)",
       color ="Political Affiliation")
# Interaction b/w active weight per person and political affliation 
ggplot(data = train_oh_wv_2012, 
            aes(x= act_wt_person_county ,y = as.numeric(est_death_rate_cat), color= political_aff)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Active Drug Weight Available Per Person vs Death Rate", 
       x = "Active Drug Weight Available Per Person", y = "Death Rate (Categorical)",
       color = "Political Affiliation")
```
```{r}
# interaction b/w median income and pharmacy dominance
ggplot(data = train_oh_wv_2012, 
            aes(x = median_income ,y = as.numeric(est_death_rate_cat),color = dominance)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Median Income vs Death Rate",
       x = "Median Income", y = "Death Rate (Categorical)",
       color = "Pharmacy Dominance")
# Interaction b/w number of pharmacies and pharmacy dominance
ggplot(data=train_oh_wv_2012, 
       aes(x= pharmacy_num_ptt ,y=as.numeric(est_death_rate_cat) ,color= dominance)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Number of Pharmacies per 10,000 People vs Death Rate", 
       x = "Number of Pharmacies", y = "Death Rate (Categorical)",
       color = "Pharmacy Dominance")
# Interaction b/w % oxycodone and political affliation 
ggplot(data=train_oh_wv_2012, 
             aes(x = perc_oxy,y = as.numeric(est_death_rate_cat), color= dominance)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Percentage Oxycodone vs Death Rate", 
       x = "Percentage Oxycodone", y= "Death Rate (Categorical)",
       color ="Pharmacy Dominance")
# Interaction b/w active weight per person and political affliation 
ggplot(data = train_oh_wv_2012, 
            aes(x= act_wt_person_county ,y = as.numeric(est_death_rate_cat), color= dominance)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Active Drug Weight Available Per Person vs Death Rate", 
       x = "Active Drug Weight Available Per Person", y = "Death Rate (Categorical)",
       color = "Pharmacy Dominance")
```

```{r}
# interaction b/w median income and most common distribution channel
ggplot(data = train_oh_wv_2012, 
            aes(x = median_income ,y = as.numeric(est_death_rate_cat),color = most_dist_channel)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Median Income vs Death Rate",
       x = "Median Income", y = "Death Rate (Categorical)",
       color = "Most Common Distribution Channel")
# Interaction b/w number of pharmacies and most common distribtuion channel
ggplot(data=train_oh_wv_2012, 
       aes(x= pharmacy_num_ptt ,y=as.numeric(est_death_rate_cat) ,color= most_dist_channel)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Number of Pharmacies per 10,000 People vs Death Rate", 
       x = "Number of Pharmacies", y = "Death Rate (Categorical)",
       color = "Most Common Distribution Channel")
# Interaction b/w % oxycodone and most common distribtuion channel
ggplot(data=train_oh_wv_2012, 
             aes(x = perc_oxy,y = as.numeric(est_death_rate_cat), color= most_dist_channel)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Percentage Oxycodone vs Death Rate", 
       x = "Percentage Oxycodone", y= "Death Rate (Categorical)",
       color ="Most Common Distribution Channel")
# Interaction b/w active weight per person and most common distribtuion channel
ggplot(data = train_oh_wv_2012, 
            aes(x= act_wt_person_county ,y = as.numeric(est_death_rate_cat), color= most_dist_channel)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Active Drug Weight Available Per Person vs Death Rate", 
       x = "Active Drug Weight Available Per Person", y = "Death Rate (Categorical)",
       color = "Most Common Distribution Channel")
```


## Modeling

### Regular Logistic Regression
```{r}
# with interactions
fit0 <- nnet::multinom(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt, data=train_oh_wv_2012)
summary(fit0)

# with interactions
fit0.interact <- nnet::multinom(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt + log(median_income)*political_aff+act_wt_person_county*distr_num_ptt+act_wt_person_county*pharmacy_num_ptt+pharmacy_num_ptt*political_aff+log(median_income)*most_dist_channel+log(median_income)*pharmacy_num_ptt+perc_oxy*dominance+act_wt_person_county*perc_oxy, data=train_oh_wv_2012)
summary(fit0.interact)
```


### Cumulative logistic regression
```{r}
### cumulative logistic regression, HIGHER AIC, BETTER THAN PROP.
cumu.logistic = nnet::multinom(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt, data=train_oh_wv_2012)
summary(cumu.logistic)
mostImportantVariables <- varImp(cumu.logistic)
mostImportantVariables$Variables <- row.names(mostImportantVariables)
mostImportantVariables <- mostImportantVariables[order(-mostImportantVariables$Overall),]
print(head(mostImportantVariables))
knitr::kable(cumu.logistic %>% tidy(conf.int=TRUE),format="html",digits=3)
```

```{r}
### polyr 
library(MASS)
fit1<-polr(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt, data=train_oh_wv_2012, Hess=TRUE, method="logistic")
summary(fit1)
(ctable <- coef(summary(fit1)))
## calculate and store p values
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2

## combined table
(ctable <- cbind(ctable, "p value" = p))
#not significant at p=0.05: most dist channel retail, perc_oxy
```

#### Model with interactions 
```{r}
### polyr with interactions, 268.1159
fit1_interact<-polr(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt + log(median_income)*political_aff+act_wt_person_county*distr_num_ptt+act_wt_person_county*pharmacy_num_ptt+pharmacy_num_ptt*political_aff+log(median_income)*most_dist_channel+log(median_income)*pharmacy_num_ptt+perc_oxy*dominance+act_wt_person_county*perc_oxy, data=train_oh_wv_2012, Hess=TRUE, method="logistic")
summary(fit1_interact)
(ctable.interact.1 <- coef(summary(fit1_interact)))
## calculate and store p values
p1.interact <- pnorm(abs(ctable.interact.1[, "t value"]), lower.tail = FALSE) * 2

## combined table
(ctable.interact.1 <- cbind(ctable.interact.1, "p value" = p1.interact))
#not significant at p=0.05: political aff republican, active weight pp county, perc, oxy, distr_num_ptt, income*political, act weight * no. of dist., pharmacy nu * active weight, pharmacy num * political, dominance yes: perc_oxy, active weight* oxy 

#sig ones: dist channel retail * income, pharmacy*income

##ordinal with interactions AIC: 317.8469
fit1_interact_ord<-nnet::multinom(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt + log(median_income)*political_aff+act_wt_person_county*distr_num_ptt+act_wt_person_county*pharmacy_num_ptt+pharmacy_num_ptt*political_aff+log(median_income)*most_dist_channel+log(median_income)*pharmacy_num_ptt+perc_oxy*dominance+act_wt_person_county*perc_oxy, data=train_oh_wv_2012)
summary(fit1_interact_ord)
mostImportantVariables.ord.interact <- varImp(fit1_interact_ord)
mostImportantVariables.ord.interact$Variables <- row.names(mostImportantVariables.ord.interact)
mostImportantVariables.ord.interact <- mostImportantVariables.ord.interact[order(-mostImportantVariables.ord.interact$Overall),]
print(head(mostImportantVariables.ord.interact))
knitr::kable(fit1_interact_ord %>% tidy(conf.int=TRUE),format="html",digits=3)
```

### HierNet (Lasso for interactions)
 - only works for numerical response variable... rip
```{r eval=FALSE}
library(hierNet)
pred_matrix <- train_oh_wv_2012 %>%  #x is a matrix of predictors
  mutate(log_income = log(median_income)) %>%
  select(pharmacy_num_ptt, most_dist_channel, dominance, log_income,  political_aff, act_wt_person_county, perc_oxy, distr_num_ptt)

hierNet(x = pred_matrix, y = train_oh_wv_2012$est_death_rate_cat, lam = 0.1)

```

### Tree Models
```{r}
## Classification tree model 
set.seed(13)
class.tree.1 <- tree(est_death_rate_cat ~ log(pharmacy_num) + most_dist_channel + dominance + 
                       log(median_income) + political_aff +  log(act_wt_person_county), data=train_oh_wv_2012)
summary(class.tree.1)
plot(class.tree.1) 
text(class.tree.1, pretty = 0)
class.tree.1 # Branches that lead to terminal nodes are indicated using asterisks
```
