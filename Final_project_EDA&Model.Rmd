---
title: "final project_EDA and Model"
author: "Alice Liao, Revo Tesha, Salvador, Cindy, Evelyn "
date: "12/1/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readr)
library(cowplot)
library(janitor)
library(nnet)
library(caret)
library(broom)
library(tree)
library(brms)
set.seed(10)
```

## Exploratory Data Analysis for oh_wv_2012 Dataset

### Training data
```{r}
oh_wv_2012 <- read.csv("data/oh_wv_2012.csv", header = TRUE)
set.seed(1000)
train = sample(max(dim(oh_wv_2012)), max(dim(oh_wv_2012))*0.75) # 75% training
train_oh_wv_2012 = oh_wv_2012[train,]
test_oh_wv_2012 = oh_wv_2012[-train,]
```

### Distribution of Variables (and possible transformations):
```{r}
summary(train_oh_wv_2012)
```

```{r}
# death rate - numerical
death_rate_p = ggplot(train_oh_wv_2012, aes(x = imput_est_death_rate_num)) +
  geom_histogram() +
  labs(x = "Estimated death rate")

tdeath_rate_p = ggplot(train_oh_wv_2012, aes(x = log(imput_est_death_rate_num))) +
  geom_histogram() +
  labs(x = "log of xsEstimated death rate")

plot_grid(death_rate_p,tdeath_rate_p)

# death rate - categorial
ggplot(train_oh_wv_2012)+
  geom_bar(aes(x = est_death_rate_cat)) +
  labs(x = "Death Rate (Categorical)",
       title = "Distribution of Death Rate")
```


```{r}
# hydrocodone -- log transformation
hyd_wt_p = ggplot(train_oh_wv_2012, aes(x = hyd_wt)) +
  geom_histogram() +
  labs(x = "Total Active Weight for Hydrocodone")
thyd_wt_p = ggplot(train_oh_wv_2012, aes(x = log(hyd_wt))) +
  geom_histogram() +
  labs(x = "Log Total Active Weight for Hydrocodone")
plot_grid(hyd_wt_p, thyd_wt_p)

# % hydrocodone 
hyd_perc_p = ggplot(train_oh_wv_2012, aes(perc_hyd))+
  geom_histogram()
thyd_perc_p = ggplot(train_oh_wv_2012, aes(log(perc_hyd)))+
  geom_histogram()
plot_grid(hyd_perc_p, thyd_perc_p)
```

```{r}
# oxycodone -- log transformation
oxy_wt_p = ggplot(train_oh_wv_2012, aes(x = oxy_wt)) +
  geom_histogram() +
  labs(x = "Total Active Weight for Oxycodone")
toxy_wt_p = ggplot(train_oh_wv_2012, aes(x = log(oxy_wt))) +
  geom_histogram() +
  labs(x = "Log Total Active Weight for Oxycodone")
plot_grid(oxy_wt_p, toxy_wt_p)

# % oxycodone
oxy_perc_p = ggplot(train_oh_wv_2012, aes(perc_oxy))+
  geom_histogram() +
  labs(x = "% of oxycodone by active weight",
       title = "Distribution of % of oxycodone by active weight")
  
toxy_perc_p = ggplot(train_oh_wv_2012, aes(log(perc_oxy)))+
  geom_histogram()
plot_grid(oxy_perc_p, toxy_perc_p)
```

```{r}
# number of distributors per 10,000 in a county -- no log transformation necessary
ndptt_p = ggplot(train_oh_wv_2012, aes(x = distr_num_ptt)) +
  geom_histogram() +
  labs(x = "Number of Drug Suppliers per 10,000",
       title = "Number of Drug Suppliers per 10,000 in a County")
tndptt_p = ggplot(train_oh_wv_2012, aes(x = log(distr_num_ptt))) +
  geom_histogram() +
  labs(x = "Log Number of Distributors per 10,000 in a County")
plot_grid(ndptt_p, tndptt_p)
```

```{r}
# number of pharmacies per 10,000 for a county -- no transformation necessary
nptt_p = ggplot(train_oh_wv_2012, aes(x = pharmacy_num_ptt)) +
  geom_histogram() +
  labs(x = "Number of Pharmacies per 10,000",
       title = "Number of Pharmacies per 10,000 in a County")
nptt_p
```

```{r}
# distribution of median income - need log transformation
med_income = ggplot(train_oh_wv_2012, aes(x = median_income)) +
  geom_histogram() +
  labs(x = "Median income")
log_med_income = ggplot(train_oh_wv_2012, aes(x = log(median_income))) +
  geom_histogram() +
  labs(x = "Log median income")
plot_grid(med_income, log_med_income)
```

```{r}
# active drug weight per person in a county -- no log transformation necessary
actwt_pp_plot = ggplot(train_oh_wv_2012, aes(x = act_wt_person_county)) +
  geom_histogram() +
  labs(x = "active weight per person (in grams)",
       title = "Distribution of active weight of opioid \navailable to each person")
log_actwt_pp_plot = ggplot(train_oh_wv_2012, aes(x = log(act_wt_person_county))) +
  geom_histogram() +
  labs(x = "Log active weight per person")
plot_grid(actwt_pp_plot, log_actwt_pp_plot)
```

### Predictors vs. Response:

#### Responses: Death Rate Category
```{r}
ggplot(data = train_oh_wv_2012, aes(x = est_death_rate_cat, y = Population)) + 
  geom_boxplot()+ 
  labs(x = "Estimated Death Rate Category", ylab = "County Population",
        main = "Death Rate Category vs County Population") 

ggplot(data = train_oh_wv_2012, aes(x = est_death_rate_cat, y = pharmacy_num_ptt)) + 
  geom_boxplot() + 
  labs(x = "Estimated Death Rate Category", 
       y = "Number of Pharmacies", 
       main = "Death Rate Category vs Number of Pharmacies per 10,000 Population") 

ggplot(data = train_oh_wv_2012, aes(x = est_death_rate_cat, y = distr_num_ptt)) +
  geom_boxplot() +
  labs(x = "Death Rate Category", y = "Number of manufacturers involved",
       title = "County death rate vs Number of Manufacturers")

#####################################################################################
ggplot(data = train_oh_wv_2012, aes(x = all_active_wt, y = est_death_rate_cat)) + 
  geom_boxplot() + xlab("Active weight total") + ylab("Estimated Death Rate Category") 

train_oh_wv_2012 %>%
  ggplot(aes(x = most_dist_channel, y = est_death_rate_cat)) + geom_boxplot() + xlab("Most Distributed Channel") + ylab("Estimated Death Rate Category") 
  
```

#### Response: Median Income - IGNORE THIS MODEL FIRST

```{r eval=FALSE}
oh_wv_2012 %>%
  ggplot(mapping = aes(x = Political.affiliation, y = median_income)) + geom_boxplot() + xlab("Political Affiliation") + ylab("Median Income")

oh_wv_2012 %>%
  ggplot(mapping = aes(x = dominance, y = median_income)) + geom_boxplot() + xlab("Dominance") + ylab("Median Income")


oh_wv_2012 %>%
  ggplot(mapping = aes(x = all_active_wt , y = median_income)) + geom_point()  + xlab("All Active Weight") + ylab("Median Income")

med_inc_mod3 <- lm(median_income ~ all_active_wt, data = oh_wv_2012)
plot(med_inc_mod3)


oh_wv_2012 %>%
  ggplot(mapping = aes(x = most_dist_channel , y = median_income)) +  geom_boxplot()  + xlab(" Most Distributed Channel") + ylab("Median Income")

oh_wv_2012 %>%
  ggplot(mapping = aes(x = pharmacy_num , y = median_income)) + geom_point()  + xlab("Number of Pharamacies") + ylab("Median Income")

med_inc_mod6 <- lm(median_income ~ pharmacy_num, data = oh_wv_2012)
plot(med_inc_mod6)


oh_wv_2012 %>%
  ggplot(mapping = aes(x = Population , y = median_income)) + geom_point()  + xlab("Population") + ylab("Median Income")

med_inc_mod7 <- lm(median_income ~ Population, data = oh_wv_2012)
plot(med_inc_mod7)

```

### Plot predictors against each other (Interactions)
```{r}
# number of manufactueres (ptt) vs death rate by number of pharmacies (ptt)
ggplot(train_oh_wv_2012,
       aes(x = distr_num_ptt, y = as.numeric(est_death_rate_cat), color = pharmacy_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Number of Distributors per 10,000 People vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Number of Distributors per 10,000 People",
       y = "Estimated Death Rate Category",
       color = "Number of Pharmacies \nper 10,000 People")
ggplot(train_oh_wv_2012,
       aes(x = distr_num_ptt, y = pharmacy_num_ptt))+
  geom_point()

# % oxycodone vs death rate by number of pharmacies (ptt)
ggplot(train_oh_wv_2012,
       aes(x = perc_oxy, y = as.numeric(est_death_rate_cat), color = pharmacy_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Percentage Oxycodone vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Percentage Oxycodone",
       y = "Estimated Death Rate Category",
       color = "Number of Pharmacies \nper 10,000 People")

ggplot(train_oh_wv_2012,
       aes(x = perc_oxy, y = pharmacy_num_ptt))+
  geom_point()

# % oxycodone vs death rate by number of manufacturers
ggplot(train_oh_wv_2012,
       aes(x = perc_oxy, y = as.numeric(est_death_rate_cat), color = distr_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Percentage Oxycodone vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Percentage Oxycodone",
       y = "Estimated Death Rate Category",
       color = "Number of Drug Manufacturers")

ggplot(train_oh_wv_2012,
       aes(x = perc_oxy, y = distr_num_ptt))+
  geom_point()

# active weight per person vs number of pharmacies
ggplot(train_oh_wv_2012,
       aes(x = act_wt_person_county, y = as.numeric(est_death_rate_cat), color = pharmacy_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Active Weight vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Active weight per person",
       y = "Estimated Death Rate Category",
       color = "Number of Pharmacies \nper 10,000 People")
  

# number of manufacturers vs active weight per person
ggplot(train_oh_wv_2012,
       aes(x = act_wt_person_county, y = as.numeric(est_death_rate_cat), color = distr_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Active Weight vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Active weight per person",
       y = "Estimated Death Rate Category",
       color = "Number of Drug Manufacturers")

ggplot(train_oh_wv_2012,
       aes(x = act_wt_person_county, y = distr_num_ptt))+
  geom_point()

# income vs number of pharmacies
ggplot(train_oh_wv_2012,
       aes(x = median_income, y = as.numeric(est_death_rate_cat), color = pharmacy_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Median Income vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Median Income",
       y = "Estimated Death Rate Category",
       color = "Number of Pharmacies")
  
```


```{r}
# interaction b/w median income and political affiliation
ggplot(data = train_oh_wv_2012, 
            aes(x = median_income ,y = as.numeric(est_death_rate_cat),color = political_aff)) +
  geom_point()+
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Median Income vs Death Rate",
       x = "Median Income", y = "Death Rate (Categorical)",
       color = "Political Affiliation")
# Interaction b/w number of pharmacies and political affliation 
ggplot(data=train_oh_wv_2012, 
       aes(x= pharmacy_num_ptt ,y = as.numeric(est_death_rate_cat), color= political_aff)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Number of Pharmacies per 10,000 People vs Death Rate", 
       x = "Number of Pharmacies per 10,000 People", y = "Death Rate (Categorical)",
       color = "Political Affiliation")
# Interaction b/w % oxycodone and political affliation 
ggplot(data=train_oh_wv_2012, 
             aes(x = perc_oxy,y = as.numeric(est_death_rate_cat), color= political_aff)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Percentage Oxycodone vs Death Rate", 
       x = "Percentage Oxycodone", y= "Death Rate (Categorical)",
       color ="Political Affiliation")
# Interaction b/w active weight per person and political affliation 
ggplot(data = train_oh_wv_2012, 
            aes(x= act_wt_person_county ,y = as.numeric(est_death_rate_cat), color= political_aff)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Active Drug Weight Available Per Person vs Death Rate", 
       x = "Active Drug Weight Available Per Person", y = "Death Rate (Categorical)",
       color = "Political Affiliation")
```


```{r}
# interaction b/w median income and pharmacy dominance
ggplot(data = train_oh_wv_2012, 
            aes(x = median_income ,y = as.numeric(est_death_rate_cat),color = dominance)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Median Income vs Death Rate",
       x = "Median Income", y = "Death Rate (Categorical)",
       color = "Pharmacy Dominance")
# Interaction b/w number of pharmacies and pharmacy dominance
ggplot(data=train_oh_wv_2012, 
       aes(x= pharmacy_num_ptt ,y=as.numeric(est_death_rate_cat) ,color= dominance)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Number of Pharmacies per 10,000 People vs Death Rate", 
       x = "Number of Pharmacies", y = "Death Rate (Categorical)",
       color = "Pharmacy Dominance")
# Interaction b/w % oxycodone and political affliation 
ggplot(data=train_oh_wv_2012, 
             aes(x = perc_oxy,y = as.numeric(est_death_rate_cat), color= dominance)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Percentage Oxycodone vs Death Rate", 
       x = "Percentage Oxycodone", y= "Death Rate (Categorical)",
       color ="Pharmacy Dominance")
# Interaction b/w active weight per person and political affliation 
ggplot(data = train_oh_wv_2012, 
            aes(x= act_wt_person_county ,y = as.numeric(est_death_rate_cat), color= dominance)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Active Drug Weight Available Per Person vs Death Rate", 
       x = "Active Drug Weight Available Per Person", y = "Death Rate (Categorical)",
       color = "Pharmacy Dominance")
```


```{r}
# interaction b/w median income and most common distribution channel
ggplot(data = train_oh_wv_2012, 
            aes(x = median_income ,y = as.numeric(est_death_rate_cat),color = most_dist_channel)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Median Income vs Death Rate",
       x = "Median Income", y = "Death Rate (Categorical)",
       color = "Most Common \nDistribution Channel")
# Interaction b/w number of pharmacies and most common distribtuion channel
ggplot(data=train_oh_wv_2012, 
       aes(x= pharmacy_num_ptt ,y=as.numeric(est_death_rate_cat) ,color= most_dist_channel)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Number of Pharmacies per 10,000 People vs Death Rate", 
       x = "Number of Pharmacies", y = "Death Rate (Categorical)",
       color = "Most Common \nDistribution Channel")
# Interaction b/w % oxycodone and most common distribtuion channel
ggplot(data=train_oh_wv_2012, 
             aes(x = perc_oxy,y = as.numeric(est_death_rate_cat), color= most_dist_channel)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Percentage Oxycodone vs Death Rate", 
       x = "Percentage Oxycodone", y= "Death Rate (Categorical)",
       color ="Most Common \nDistribution Channel")
# Interaction b/w active weight per person and most common distribtuion channel
ggplot(data = train_oh_wv_2012, 
            aes(x= act_wt_person_county ,y = as.numeric(est_death_rate_cat), color= most_dist_channel)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Active Drug Weight Available Per Person vs Death Rate", 
       x = "Active Drug Weight Available Per Person", y = "Death Rate (Categorical)",
       color = "Most Common \nDistribution Channel")
```


## Modeling

### Regular Logistic Regression
```{r}
# with interactions
fit0 <- nnet::multinom(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt, data=train_oh_wv_2012)
summary(fit0)

# with interactions
fit0.interact <- nnet::multinom(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt + log(median_income)*political_aff+act_wt_person_county*distr_num_ptt+act_wt_person_county*pharmacy_num_ptt+pharmacy_num_ptt*political_aff+log(median_income)*most_dist_channel+log(median_income)*pharmacy_num_ptt+perc_oxy*dominance+act_wt_person_county*perc_oxy, data=train_oh_wv_2012)
summary(fit0.interact)
```


### Cumulative logistic regression
```{r}
### cumulative logistic regression, HIGHER AIC, BETTER THAN PROP.
cumu.logistic = nnet::multinom(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt, data=train_oh_wv_2012)
summary(cumu.logistic)
mostImportantVariables <- varImp(cumu.logistic)
mostImportantVariables$Variables <- row.names(mostImportantVariables)
mostImportantVariables <- mostImportantVariables[order(-mostImportantVariables$Overall),]
print(head(mostImportantVariables))
knitr::kable(cumu.logistic %>% tidy(conf.int=TRUE),format="html",digits=3)
```

```{r}
### polyr 
library(MASS)
fit1<-polr(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt, data=train_oh_wv_2012, Hess=TRUE, method="logistic")
summary(fit1)
(ctable <- coef(summary(fit1)))
## calculate and store p values
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2

## combined table
(ctable <- cbind(ctable, "p value" = p))
#not significant at p=0.05: most dist channel retail, perc_oxy
```

#### Model with interactions 
```{r}
### polyr with interactions, 268.1159
fit1_interact<-polr(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt + log(median_income)*political_aff+act_wt_person_county*distr_num_ptt+act_wt_person_county*pharmacy_num_ptt+pharmacy_num_ptt*political_aff+log(median_income)*most_dist_channel+log(median_income)*pharmacy_num_ptt+perc_oxy*dominance+act_wt_person_county*perc_oxy, data=train_oh_wv_2012, Hess=TRUE, method="logistic")
summary(fit1_interact)
(ctable.interact.1 <- coef(summary(fit1_interact)))
## calculate and store p values
p1.interact <- pnorm(abs(ctable.interact.1[, "t value"]), lower.tail = FALSE) * 2

## combined table
(ctable.interact.1 <- cbind(ctable.interact.1, "p value" = p1.interact))
#not significant at p=0.05: political aff republican, active weight pp county, perc, oxy, distr_num_ptt, income*political, act weight * no. of dist., pharmacy nu * active weight, pharmacy num * political, dominance yes: perc_oxy, active weight* oxy 

#sig ones: dist channel retail * income, pharmacy*income

##ordinal with interactions AIC: 317.8469
fit1_interact_ord<-nnet::multinom(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt + log(median_income)*political_aff+act_wt_person_county*distr_num_ptt+act_wt_person_county*pharmacy_num_ptt+pharmacy_num_ptt*political_aff+log(median_income)*most_dist_channel+log(median_income)*pharmacy_num_ptt+perc_oxy*dominance+act_wt_person_county*perc_oxy, data=train_oh_wv_2012)
summary(fit1_interact_ord)
mostImportantVariables.ord.interact <- varImp(fit1_interact_ord)
mostImportantVariables.ord.interact$Variables <- row.names(mostImportantVariables.ord.interact)
mostImportantVariables.ord.interact <- mostImportantVariables.ord.interact[order(-mostImportantVariables.ord.interact$Overall),]
print(head(mostImportantVariables.ord.interact))
knitr::kable(fit1_interact_ord %>% tidy(conf.int=TRUE),format="html",digits=3)
```


### Tree Models
```{r}
pred_matrix <- train_oh_wv_2012 %>%  #x is a matrix of predictors
  mutate(log_income = log(median_income)) %>%
  dplyr::select(est_death_rate_cat, pharmacy_num_ptt, most_dist_channel, dominance, log_income,  political_aff, act_wt_person_county, perc_oxy, distr_num_ptt)

## Classification tree model 
set.seed(1)
classtree <- tree(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) + political_aff + act_wt_person_county + perc_oxy + distr_num_ptt, data=train_oh_wv_2012)
summary(classtree)
plot(classtree) 
text(classtree, pretty = 0) # The most important predictor is pharmacy-num-ptt

deathrate.test <- test_oh_wv_2012$est_death_rate_cat
classtree.pred <- predict(classtree, test_oh_wv_2012, type = "class") 
table(classtree.pred, deathrate.test)
sum(diag(table(classtree.pred, deathrate.test)))/36 # correctly classified ~36%.

library(e1071)
caret::confusionMatrix(classtree.pred, deathrate.test)

library(mltest)
ml_test(classtree.pred, deathrate.test, output.as.table = FALSE)
```


```{r}
## Pruned classfiction tree model
set.seed(3)
cv.classtree <- cv.tree(classtree, FUN = prune.misclass) 
cv.classtree
par(mfrow = c(1,2))
plot(cv.classtree$size, cv.classtree$dev, type = "b") # lowest cv-error is when #nodes = 6
plot(cv.classtree$k, cv.classtree$dev, type = "b")

prune.classtree <- prune.misclass(classtree, best = 3) 
plot(prune.classtree)
text(prune.classtree, pretty = 0)
prunetree.pred <- predict(prune.classtree, newdata = test_oh_wv_2012, type = "class") 

table(prunetree.pred, deathrate.test)
sum(diag(table(prunetree.pred, deathrate.test)))/36 # correctly classified ~38.8%
```

```{r}
## Bagging 
library(randomForest)
set.seed(4)
bagtree <- randomForest(est_death_rate_cat ~., data = pred_matrix, mtry = 8, importance = TRUE, ntree = 25)
bagtree

bag.test <- test_oh_wv_2012 %>%
mutate(log_income = log(median_income)) %>%
dplyr::select(est_death_rate_cat, pharmacy_num_ptt, most_dist_channel, dominance, log_income, political_aff, act_wt_person_county, perc_oxy, distr_num_ptt)

bagtree.pred <- predict(bagtree, newdata = bag.test) 
table(bagtree.pred, deathrate.test)
sum(diag(table(bagtree.pred, deathrate.test)))/36 # correctly classified ~36%
```

```{r}
## RF
set.seed(5)
rf.tree <- randomForest(est_death_rate_cat ~., data = pred_matrix, mtry = 3, importance = TRUE)
rf.tree


rf.pred <- predict(rf.tree, newdata = bag.test) 
table(rf.pred, deathrate.test)
sum(diag(table(rf.pred, deathrate.test)))/36 # correctly classified ~41.6%

importance(rf.tree) # log_income and act_wt_person are most important predictors
varImpPlot(rf.tree)
```

```{r}
## Boosting
library(gbm)
set.seed(6)
boost <- gbm(est_death_rate_cat ~ ., data = pred_matrix, distribution = "multinomial", n.trees = 5000, interaction.depth = 1) # distribution = "gaussian"
summary(boost)
boost.pred <- predict(boost, newdata = bag.test, n.trees = 5000)

table(boost.pred, deathrate.test)
sum(diag(table(boost.pred, deathrate.test)))/36 # correctly classified ~5.55%

```

### Ordinal Net 
```{r}
library(ordinalNet)
set.seed(1234)
y<-as.factor(train_oh_wv_2012$est_death_rate_cat)
x<-model.matrix(est_death_rate_cat~., pred_matrix)
class(x)
ordnet1 <- ordinalNet(x, y, family="cumulative", link="logit",
                   parallelTerms=TRUE, nonparallelTerms=TRUE, alpha=1, # alpha = 1 means Lasso
                   standardize = TRUE)

summary(ordnet1)
coef(ordnet1, matrix=TRUE, criteria="aic") #by default, best AIC model is returned

# CV by misclassification error
# ordinalNetCV(x, y, tuneMethod = "cvMisclass")
```

### Calculate accuracy for all logistic regression models 
#### fit1_interact_ord
```{r}
deathrate.test <- test_oh_wv_2012$est_death_rate_cat
classtree.pred.fit1_interact_ord <- predict(fit1_interact_ord, test_oh_wv_2012, type = "class") 
table(classtree.pred.fit1_interact_ord, deathrate.test)
sum(diag(table(classtree.pred.fit1_interact_ord, deathrate.test)))/36
```
#### fit0_interact
```{r}
deathrate.test <- test_oh_wv_2012$est_death_rate_cat
classtree.pred.fit0.interact <- predict(fit0.interact, test_oh_wv_2012, type = "class") 
table(classtree.pred.fit0.interact, deathrate.test)
sum(diag(table(classtree.pred.fit0.interact, deathrate.test)))/36
```
#### ordnet
```{r}
pred_matrix.ordnet1 <- test_oh_wv_2012 %>%  #x is a matrix of predictors
  mutate(log_income = log(median_income)) %>%
  dplyr::select(est_death_rate_cat, pharmacy_num_ptt, most_dist_channel, dominance, log_income,
                political_aff, act_wt_person_county, perc_oxy, distr_num_ptt)

x.test.ordnet1<-model.matrix(est_death_rate_cat~., pred_matrix.ordnet1)

ordnet.pred<-predict(ordnet1, newx = x.test.ordnet1, whichLambda = NULL,
      criteria = "aic", type = "class")

deathrate.test <- as.character(test_oh_wv_2012$est_death_rate_cat)
no.cat.test<-str_replace(deathrate.test, "cat_", "")
no.cat.test<-as.numeric(no.cat.test)

table(ordnet.pred, no.cat.test)
z<-c(0, 0, 0, 0, 0)
table<-rbind(table(ordnet.pred, no.cat.test), z)
sum(diag(table))/36
```


#### prediction plots for ordnet model
```{r}
# coefs = coef(ordnet1, matrix=TRUE, criteria="aic")
# coefs
# coefs[3,1]

 # intercept = case_when(
 #   logit_class == "logit(P[Y<=1])" ~ coefs[1,1],
 #   logit_class == "logit(P[Y<=2])" ~ coefs[1,2],
 #   logit_class == "logit(P[Y<=3])" ~ coefs[1,3],
 #   logit_class == "logit(P[Y<=4])" ~ coefs[1,4],
 #   logit_class == "logit(P[Y<=5])" ~ coefs[1,5]
 # ),
 # slope = case_when(
 #   logit_class == "logit(P[Y<=1])" ~ coefs[3,1],
 #   logit_class == "logit(P[Y<=2])" ~ coefs[3,2],
 #   logit_class == "logit(P[Y<=3])" ~ coefs[3,3],
 #   logit_class == "logit(P[Y<=4])" ~ coefs[3,4],
 #   logit_class =="logit(P[Y<=5])" ~ coefs[3,5]),
```

```{r}
## plotting datasets

# pharmacy_num_ptt
pharmac.test.ordnet1 = as.data.frame(x.test.ordnet1) %>%
  mutate(`most_dist_channelRETAIL PHARMACY` = 1, dominanceYes = 1, log_income = 10.67346,
         political_affRepublican = 1,
         act_wt_person_county = 0.19294084,
         perc_oxy = 54.2, distr_num_ptt = 1.709) %>%
  as.matrix()
  
## probabilities ################################################################

classprob <- predict(ordnet1, newx = pharmac.test.ordnet1, whichLambda = NULL,
criteria = "aic", type = "response")

# plotting
classprob_df = as.data.frame(classprob) %>%
  cbind(pharmac.test.ordnet1) %>%
  dplyr::select(pharmacy_num_ptt, `P[Y=1]`:`P[Y=6]`) %>%
  gather(key = "class", value = "probability", `P[Y=1]`:`P[Y=6]`) %>%
  mutate(class = as.factor(class))

ggplot(classprob_df, aes(x = pharmacy_num_ptt, y = probability)) +
    # geom_point(aes(x = pharmacy_num_ptt, y = probability, color = class)) +
    geom_line(aes(x = pharmacy_num_ptt, y = probability,
                  color = class,
                  group = class)) +
    # scale_x_discrete(limits = classprob_df$class) + 
    labs(title = "Probabilities for Number of Pharmacies PTT", 
         y = "P(Y=j)",
         x= "Number of Pharmacies PTT") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank())

## cumulative ##################################################################
classcumprob <- predict(ordnet1, newx = pharmac.test.ordnet1, whichLambda = NULL,
criteria = "aic", type = "link")

# plotting
classcumprob_df = as.data.frame(classcumprob) %>%
  cbind(pharmac.test.ordnet1) %>%
  dplyr::select(pharmacy_num_ptt, `logit(P[Y<=1])`:`logit(P[Y<=5])`) %>%
  gather(key = "logit_class", value = "logit_value", `logit(P[Y<=1])`:`logit(P[Y<=5])`) %>%
  mutate(logit_class = as.factor(logit_class),
         class = as.character(logit_class),
         class = str_extract(class, "P\\[Y<=\\d\\]"),
         probability = (exp(logit_value))/
           (1 + exp(logit_value)))
  

ggplot(classcumprob_df, aes(x = pharmacy_num_ptt, y = probability)) +
    # geom_point(aes(x = pharmacy_num_ptt, y = probability, color = class)) +
    geom_line(aes(x = pharmacy_num_ptt, y = probability,
                  color = class,
                  group = class)) +
    # scale_x_discrete(limits = classprob_df$class) + 
    labs(title = "Cumulative Probabilities for Number of Pharmacies PTT", 
         y = "P(Y<=j)",
         x= "Number of Pharmacies PTT") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank())
```