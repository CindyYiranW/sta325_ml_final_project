---
title: "final project_EDA and Model"
author: "Alice Liao, Revo Tesha, Salvador, Cindy, Evelyn "
date: "12/1/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readr)
library(cowplot)
library(janitor)
library(nnet)
library(caret)
library(glm.predict)
if("patchwork" %in% installed.packages() == FALSE){
  if("devtools" %in% installed.packages() == FALSE){
    install.packages("devtools")}
  library(devtools)
  devtools::install_github("thomasp85/patchwork")
}
library(patchwork)
library(broom)
library(tree)
library(brms)
set.seed(10)
```

## Exploratory Data Analysis for oh_wv_2012 Dataset

### Training data
```{r}
oh_wv_2012 <- read.csv("data/oh_wv_2012.csv", header = TRUE)
set.seed(1000)
train = sample(max(dim(oh_wv_2012)), max(dim(oh_wv_2012))*0.75) # 75% training
train_oh_wv_2012 = oh_wv_2012[train,]
test_oh_wv_2012 = oh_wv_2012[-train,]
```

### Distribution of Variables (and possible transformations):
```{r}
summary(train_oh_wv_2012)
```

```{r}
# death rate - numerical
death_rate_p = ggplot(train_oh_wv_2012, aes(x = imput_est_death_rate_num)) +
  geom_histogram() +
  labs(x = "Estimated death rate")
tdeath_rate_p = ggplot(train_oh_wv_2012, aes(x = log(imput_est_death_rate_num))) +
  geom_histogram() +
  labs(x = "log of xsEstimated death rate")
plot_grid(death_rate_p,tdeath_rate_p)
# death rate - categorial
ggplot(train_oh_wv_2012)+
  geom_bar(aes(x = est_death_rate_cat)) +
  labs(x = "Death Rate (Categorical)",
       title = "Distribution of Death Rate")
```


```{r}
# hydrocodone -- log transformation
hyd_wt_p = ggplot(train_oh_wv_2012, aes(x = hyd_wt)) +
  geom_histogram() +
  labs(x = "Total Active Weight for Hydrocodone")
thyd_wt_p = ggplot(train_oh_wv_2012, aes(x = log(hyd_wt))) +
  geom_histogram() +
  labs(x = "Log Total Active Weight for Hydrocodone")
plot_grid(hyd_wt_p, thyd_wt_p)
# % hydrocodone 
hyd_perc_p = ggplot(train_oh_wv_2012, aes(perc_hyd))+
  geom_histogram()
thyd_perc_p = ggplot(train_oh_wv_2012, aes(log(perc_hyd)))+
  geom_histogram()
plot_grid(hyd_perc_p, thyd_perc_p)
```

```{r}
# oxycodone -- log transformation
oxy_wt_p = ggplot(train_oh_wv_2012, aes(x = oxy_wt)) +
  geom_histogram() +
  labs(x = "Total Active Weight for Oxycodone")
toxy_wt_p = ggplot(train_oh_wv_2012, aes(x = log(oxy_wt))) +
  geom_histogram() +
  labs(x = "Log Total Active Weight for Oxycodone")
plot_grid(oxy_wt_p, toxy_wt_p)
# % oxycodone
oxy_perc_p = ggplot(train_oh_wv_2012, aes(perc_oxy))+
  geom_histogram() +
  labs(x = "% of oxycodone by active weight",
       title = "Distribution of % of oxycodone by active weight")
  
toxy_perc_p = ggplot(train_oh_wv_2012, aes(log(perc_oxy)))+
  geom_histogram()
plot_grid(oxy_perc_p, toxy_perc_p)
```

```{r}
# number of distributors per 10,000 in a county -- no log transformation necessary
ndptt_p = ggplot(train_oh_wv_2012, aes(x = distr_num_ptt)) +
  geom_histogram() +
  labs(x = "Number of Drug Suppliers per 10,000",
       title = "Number of Drug Suppliers per 10,000 in a County")
tndptt_p = ggplot(train_oh_wv_2012, aes(x = log(distr_num_ptt))) +
  geom_histogram() +
  labs(x = "Log Number of Distributors per 10,000 in a County")
plot_grid(ndptt_p, tndptt_p)
```

```{r}
# number of pharmacies per 10,000 for a county -- no transformation necessary
nptt_p = ggplot(train_oh_wv_2012, aes(x = pharmacy_num_ptt)) +
  geom_histogram() +
  labs(x = "Number of Pharmacies per 10,000",
       title = "Number of Pharmacies per 10,000 in a County")
nptt_p
```

```{r}
# distribution of median income - need log transformation
med_income = ggplot(train_oh_wv_2012, aes(x = median_income)) +
  geom_histogram() +
  labs(x = "Median income")
log_med_income = ggplot(train_oh_wv_2012, aes(x = log(median_income))) +
  geom_histogram() +
  labs(x = "Log median income")
plot_grid(med_income, log_med_income)
```

```{r}
# active drug weight per person in a county -- no log transformation necessary
actwt_pp_plot = ggplot(train_oh_wv_2012, aes(x = act_wt_person_county)) +
  geom_histogram() +
  labs(x = "active weight per person (in grams)",
       title = "Distribution of active weight of opioid \navailable to each person")
log_actwt_pp_plot = ggplot(train_oh_wv_2012, aes(x = log(act_wt_person_county))) +
  geom_histogram() +
  labs(x = "Log active weight per person")
plot_grid(actwt_pp_plot, log_actwt_pp_plot)
```

### Predictors vs. Response:

#### Responses: Death Rate Category
```{r}
ggplot(data = train_oh_wv_2012, aes(x = est_death_rate_cat, y = Population)) + 
  geom_boxplot()+ 
  labs(x = "Estimated Death Rate Category", ylab = "County Population",
        main = "Death Rate Category vs County Population") 
ggplot(data = train_oh_wv_2012, aes(x = est_death_rate_cat, y = pharmacy_num_ptt)) + 
  geom_boxplot() + 
  labs(x = "Estimated Death Rate Category", 
       y = "Number of Pharmacies", 
       main = "Death Rate Category vs Number of Pharmacies per 10,000 Population") 
ggplot(data = train_oh_wv_2012, aes(x = est_death_rate_cat, y = distr_num_ptt)) +
  geom_boxplot() +
  labs(x = "Death Rate Category", y = "Number of manufacturers involved",
       title = "County death rate vs Number of Manufacturers")
#####################################################################################
ggplot(data = train_oh_wv_2012, aes(x = all_active_wt, y = est_death_rate_cat)) + 
  geom_boxplot() + xlab("Active weight total") + ylab("Estimated Death Rate Category") 
train_oh_wv_2012 %>%
  ggplot(aes(x = most_dist_channel, y = est_death_rate_cat)) + geom_boxplot() + xlab("Most Distributed Channel") + ylab("Estimated Death Rate Category") 
  
```

### Plot predictors against each other (Interactions)
```{r}
# number of manufactueres (ptt) vs death rate by number of pharmacies (ptt)
ggplot(train_oh_wv_2012,
       aes(x = distr_num_ptt, y = as.numeric(est_death_rate_cat), color = pharmacy_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Number of Distributors per 10,000 People vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Number of Distributors per 10,000 People",
       y = "Estimated Death Rate Category",
       color = "Number of Pharmacies \nper 10,000 People")
ggplot(train_oh_wv_2012,
       aes(x = distr_num_ptt, y = pharmacy_num_ptt))+
  geom_point()
# % oxycodone vs death rate by number of pharmacies (ptt)
ggplot(train_oh_wv_2012,
       aes(x = perc_oxy, y = as.numeric(est_death_rate_cat), color = pharmacy_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Percentage Oxycodone vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Percentage Oxycodone",
       y = "Estimated Death Rate Category",
       color = "Number of Pharmacies \nper 10,000 People")
ggplot(train_oh_wv_2012,
       aes(x = perc_oxy, y = pharmacy_num_ptt))+
  geom_point()
# % oxycodone vs death rate by number of manufacturers
ggplot(train_oh_wv_2012,
       aes(x = perc_oxy, y = as.numeric(est_death_rate_cat), color = distr_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Percentage Oxycodone vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Percentage Oxycodone",
       y = "Estimated Death Rate Category",
       color = "Number of Drug Manufacturers")
ggplot(train_oh_wv_2012,
       aes(x = perc_oxy, y = distr_num_ptt))+
  geom_point()
# active weight per person vs number of pharmacies
ggplot(train_oh_wv_2012,
       aes(x = act_wt_person_county, y = as.numeric(est_death_rate_cat), color = pharmacy_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Active Weight vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Active weight per person",
       y = "Estimated Death Rate Category",
       color = "Number of Pharmacies \nper 10,000 People")
  
# number of manufacturers vs active weight per person
ggplot(train_oh_wv_2012,
       aes(x = act_wt_person_county, y = as.numeric(est_death_rate_cat), color = distr_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Active Weight vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Active weight per person",
       y = "Estimated Death Rate Category",
       color = "Number of Drug Manufacturers")
ggplot(train_oh_wv_2012,
       aes(x = act_wt_person_county, y = distr_num_ptt))+
  geom_point()
# income vs number of pharmacies
ggplot(train_oh_wv_2012,
       aes(x = median_income, y = as.numeric(est_death_rate_cat), color = pharmacy_num_ptt)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Median Income vs Estimated Death Rate \nby Number of Pharmacies per 10,000 People ",
       x = "Median Income",
       y = "Estimated Death Rate Category",
       color = "Number of Pharmacies")
  
```


```{r}
# interaction b/w median income and political affiliation
ggplot(data = train_oh_wv_2012, 
            aes(x = median_income ,y = as.numeric(est_death_rate_cat),color = political_aff)) +
  geom_point()+
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Median Income vs Death Rate",
       x = "Median Income", y = "Death Rate (Categorical)",
       color = "Political Affiliation")
# Interaction b/w number of pharmacies and political affliation 
ggplot(data=train_oh_wv_2012, 
       aes(x= pharmacy_num_ptt ,y = as.numeric(est_death_rate_cat), color= political_aff)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Number of Pharmacies per 10,000 People vs Death Rate", 
       x = "Number of Pharmacies per 10,000 People", y = "Death Rate (Categorical)",
       color = "Political Affiliation")
# Interaction b/w % oxycodone and political affliation 
ggplot(data=train_oh_wv_2012, 
             aes(x = perc_oxy,y = as.numeric(est_death_rate_cat), color= political_aff)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Percentage Oxycodone vs Death Rate", 
       x = "Percentage Oxycodone", y= "Death Rate (Categorical)",
       color ="Political Affiliation")
# Interaction b/w active weight per person and political affliation 
ggplot(data = train_oh_wv_2012, 
            aes(x= act_wt_person_county ,y = as.numeric(est_death_rate_cat), color= political_aff)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Active Drug Weight Available Per Person vs Death Rate", 
       x = "Active Drug Weight Available Per Person", y = "Death Rate (Categorical)",
       color = "Political Affiliation")
```


```{r}
# interaction b/w median income and pharmacy dominance
ggplot(data = train_oh_wv_2012, 
            aes(x = median_income ,y = as.numeric(est_death_rate_cat),color = dominance)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Median Income vs Death Rate",
       x = "Median Income", y = "Death Rate (Categorical)",
       color = "Pharmacy Dominance")
# Interaction b/w number of pharmacies and pharmacy dominance
ggplot(data=train_oh_wv_2012, 
       aes(x= pharmacy_num_ptt ,y=as.numeric(est_death_rate_cat) ,color= dominance)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Number of Pharmacies per 10,000 People vs Death Rate", 
       x = "Number of Pharmacies", y = "Death Rate (Categorical)",
       color = "Pharmacy Dominance")
# Interaction b/w % oxycodone and political affliation 
ggplot(data=train_oh_wv_2012, 
             aes(x = perc_oxy,y = as.numeric(est_death_rate_cat), color= dominance)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Percentage Oxycodone vs Death Rate", 
       x = "Percentage Oxycodone", y= "Death Rate (Categorical)",
       color ="Pharmacy Dominance")
# Interaction b/w active weight per person and political affliation 
ggplot(data = train_oh_wv_2012, 
            aes(x= act_wt_person_county ,y = as.numeric(est_death_rate_cat), color= dominance)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Active Drug Weight Available Per Person vs Death Rate", 
       x = "Active Drug Weight Available Per Person", y = "Death Rate (Categorical)",
       color = "Pharmacy Dominance")
```


```{r}
# interaction b/w median income and most common distribution channel
ggplot(data = train_oh_wv_2012, 
            aes(x = median_income ,y = as.numeric(est_death_rate_cat),color = most_dist_channel)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Median Income vs Death Rate",
       x = "Median Income", y = "Death Rate (Categorical)",
       color = "Most Common \nDistribution Channel")
# Interaction b/w number of pharmacies and most common distribtuion channel
ggplot(data=train_oh_wv_2012, 
       aes(x= pharmacy_num_ptt ,y=as.numeric(est_death_rate_cat) ,color= most_dist_channel)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Number of Pharmacies per 10,000 People vs Death Rate", 
       x = "Number of Pharmacies", y = "Death Rate (Categorical)",
       color = "Most Common \nDistribution Channel")
# Interaction b/w % oxycodone and most common distribtuion channel
ggplot(data=train_oh_wv_2012, 
             aes(x = perc_oxy,y = as.numeric(est_death_rate_cat), color= most_dist_channel)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Percentage Oxycodone vs Death Rate", 
       x = "Percentage Oxycodone", y= "Death Rate (Categorical)",
       color ="Most Common \nDistribution Channel")
# Interaction b/w active weight per person and most common distribtuion channel
ggplot(data = train_oh_wv_2012, 
            aes(x= act_wt_person_county ,y = as.numeric(est_death_rate_cat), color= most_dist_channel)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title="Active Drug Weight Available Per Person vs Death Rate", 
       x = "Active Drug Weight Available Per Person", y = "Death Rate (Categorical)",
       color = "Most Common \nDistribution Channel")
```


## Modeling

### Regular Logistic Regression
```{r}
# with interactions
fit0 <- nnet::multinom(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt, data=train_oh_wv_2012)
summary(fit0)
# with interactions
fit0.interact <- nnet::multinom(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt + log(median_income)*political_aff+act_wt_person_county*distr_num_ptt+act_wt_person_county*pharmacy_num_ptt+pharmacy_num_ptt*political_aff+log(median_income)*most_dist_channel+log(median_income)*pharmacy_num_ptt+perc_oxy*dominance+act_wt_person_county*perc_oxy, data=train_oh_wv_2012)
summary(fit0.interact)
```


### Cumulative logistic regression
```{r}
### cumulative logistic regression
cumu.logistic = nnet::multinom(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt, data=train_oh_wv_2012)
summary(cumu.logistic)
mostImportantVariables <- varImp(cumu.logistic)
mostImportantVariables$Variables <- row.names(mostImportantVariables)
mostImportantVariables <- mostImportantVariables[order(-mostImportantVariables$Overall),]
print(mostImportantVariables)
knitr::kable(cumu.logistic %>% tidy(conf.int=TRUE),format="html",digits=3)
```

```{r}
### polyr 
library(MASS)
fit1<-polr(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt, data=train_oh_wv_2012, Hess=TRUE, method="logistic")
summary(fit1)
ctable <- coef(summary(fit1))
## calculate and store p values
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
## combined table
ctable <- cbind(ctable, "p value" = p)
#not significant at p=0.05: most dist channel retail, perc_oxy
```

#### Model with interactions 
```{r}
### polyr with interactions
fit1_interact<-polr(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt + log(median_income)*political_aff+act_wt_person_county*distr_num_ptt+act_wt_person_county*pharmacy_num_ptt+pharmacy_num_ptt*political_aff+log(median_income)*most_dist_channel+log(median_income)*pharmacy_num_ptt+perc_oxy*dominance+act_wt_person_county*perc_oxy, data=train_oh_wv_2012, Hess=TRUE, method="logistic")
summary(fit1_interact)
(ctable.interact.1 <- coef(summary(fit1_interact)))
## calculate and store p values
p1.interact <- pnorm(abs(ctable.interact.1[, "t value"]), lower.tail = FALSE) * 2
## combined table
(ctable.interact.1 <- cbind(ctable.interact.1, "p value" = p1.interact))
#not significant at p=0.05: political aff republican, active weight pp county, perc, oxy, distr_num_ptt, income*political, act weight * no. of dist., pharmacy nu * active weight, pharmacy num * political, dominance yes: perc_oxy, active weight* oxy 
#sig ones: dist channel retail * income, pharmacy*income
##ordinal with interactions
fit1_interact_ord<-nnet::multinom(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) +  political_aff + act_wt_person_county + perc_oxy + distr_num_ptt + log(median_income)*political_aff+act_wt_person_county*distr_num_ptt+act_wt_person_county*pharmacy_num_ptt+pharmacy_num_ptt*political_aff+log(median_income)*most_dist_channel+log(median_income)*pharmacy_num_ptt+perc_oxy*dominance+act_wt_person_county*perc_oxy, data=train_oh_wv_2012)
summary(fit1_interact_ord)
mostImportantVariables.ord.interact <- varImp(fit1_interact_ord)
mostImportantVariables.ord.interact$Variables <- row.names(mostImportantVariables.ord.interact)
mostImportantVariables.ord.interact <- mostImportantVariables.ord.interact[order(-mostImportantVariables.ord.interact$Overall),]
print(head(mostImportantVariables.ord.interact))
knitr::kable(fit1_interact_ord %>% tidy(conf.int=TRUE),format="html",digits=3)
```
### Backward selection to get lowest AIC (cumulative logit with interactions)
```{r}
## fit significant predictors and interations with cumulative logit
fit.select <- stepAIC(fit1_interact, trace = FALSE)
summary(fit.select)
ctable.interact.2 <- coef(summary(fit.select))
## calculate and store p values
p2.interact <- pnorm(abs(ctable.interact.2[, "t value"]), lower.tail = FALSE) * 2
(ctable.interact.2 <- cbind(ctable.interact.2, "p value" = p2.interact))
```


### Tree Models
```{r}
pred_matrix <- train_oh_wv_2012 %>%  # a matrix of predictors
  mutate(log_income = log(median_income)) %>%
  dplyr::select(est_death_rate_cat, pharmacy_num_ptt, most_dist_channel, dominance, log_income,  political_aff, act_wt_person_county, perc_oxy, distr_num_ptt)
## Classification tree model 
set.seed(1)
classtree <- tree(est_death_rate_cat ~ pharmacy_num_ptt + most_dist_channel + dominance + log(median_income) + political_aff + act_wt_person_county + perc_oxy + distr_num_ptt, data=train_oh_wv_2012)
summary(classtree)
plot(classtree) 
text(classtree, pretty = 0) # The most important predictor is pharmacy-num-ptt
deathrate.test <- test_oh_wv_2012$est_death_rate_cat
classtree.pred <- predict(classtree, test_oh_wv_2012, type = "class") 
table(classtree.pred, deathrate.test)
sum(diag(table(classtree.pred, deathrate.test)))/36 # correctly classified ~36%.
library(e1071)
caret::confusionMatrix(classtree.pred, deathrate.test)
library(mltest)
ml_test(classtree.pred, deathrate.test, output.as.table = FALSE)
```


```{r}
## Pruned classfiction tree model
set.seed(3)
cv.classtree <- cv.tree(classtree, FUN = prune.misclass) 
cv.classtree
par(mfrow = c(1,2))
plot(cv.classtree$size, cv.classtree$dev, type = "b") # lowest cv-error is when #nodes = 6
plot(cv.classtree$k, cv.classtree$dev, type = "b")
prune.classtree <- prune.misclass(classtree, best = 3) 
plot(prune.classtree)
text(prune.classtree, pretty = 0)
prunetree.pred <- predict(prune.classtree, newdata = test_oh_wv_2012, type = "class") 
table(prunetree.pred, deathrate.test)
sum(diag(table(prunetree.pred, deathrate.test)))/36 # correctly classified ~38.8%
```

```{r}
## Bagging 
library(randomForest)
set.seed(4)
bagtree <- randomForest(est_death_rate_cat ~., data = pred_matrix, mtry = 8, importance = TRUE, ntree = 25)
bagtree
bag.test <- test_oh_wv_2012 %>%
mutate(log_income = log(median_income)) %>%
dplyr::select(est_death_rate_cat, pharmacy_num_ptt, most_dist_channel, dominance, log_income, political_aff, act_wt_person_county, perc_oxy, distr_num_ptt)
bagtree.pred <- predict(bagtree, newdata = bag.test) 
table(bagtree.pred, deathrate.test)
sum(diag(table(bagtree.pred, deathrate.test)))/36 # correctly classified ~36%
```

```{r}
## RF
set.seed(5)
rf.tree <- randomForest(est_death_rate_cat ~., data = pred_matrix, mtry = 3, importance = TRUE)
rf.tree
rf.pred <- predict(rf.tree, newdata = bag.test) 
table(rf.pred, deathrate.test)
sum(diag(table(rf.pred, deathrate.test)))/36 # correctly classified ~41.6%
importance(rf.tree) # log_income and act_wt_person are most important predictors
varImpPlot(rf.tree)
```

```{r}
## Boosting
library(gbm)
set.seed(6)
boost <- gbm(est_death_rate_cat ~ ., data = pred_matrix, distribution = "gaussian", n.trees = 5000, interaction.depth = 1) 
# distribution = "gaussian", but gaussian uses baseline logistic regression - doesn't account for order --> may not be a good model to begin with
# distribution = "multinomial" doesn't work?? 
summary(boost)
boost.pred <- predict(boost, newdata = bag.test, n.trees = 5000) # need to assign class to the numerical predicted values
dim(boost.pred)
table(boost.pred, deathrate.test)
sum(diag(table(boost.pred, deathrate.test)))/36 # correctly classified ~5.55%
```

### Ordinal Net 
```{r}
library(ordinalNet)
set.seed(1234)
y<-as.factor(train_oh_wv_2012$est_death_rate_cat)
x<-model.matrix(est_death_rate_cat~., pred_matrix)
class(x)
ordnet1 <- ordinalNet(x, y, family="cumulative", link="logit",
                   parallelTerms=TRUE, nonparallelTerms=TRUE, alpha=1, # alpha = 1 means Lasso
                   standardize = TRUE)
summary(ordnet1)
coef(ordnet1, matrix=TRUE, criteria="aic") #by default, best AIC model is returned
# CV by misclassification error
# ordinalNetCV(x, y, tuneMethod = "cvMisclass")
```

### Calculate accuracy for all logistic regression models 
#### fit1_interact_ord
```{r}
deathrate.test <- test_oh_wv_2012$est_death_rate_cat
classtree.pred.fit1_interact_ord <- predict(fit1_interact_ord, test_oh_wv_2012, type = "class") 
table(classtree.pred.fit1_interact_ord, deathrate.test)
sum(diag(table(classtree.pred.fit1_interact_ord, deathrate.test)))/36
```

#### fit.select
```{r}
deathrate.test <- test_oh_wv_2012$est_death_rate_cat
fit.select.preds <- predict(fit.select, test_oh_wv_2012, type = "class") 
table(fit.select.preds, deathrate.test)
sum(diag(table(fit.select.preds, deathrate.test)))/36
```

#### fit0_interact
```{r}
deathrate.test <- test_oh_wv_2012$est_death_rate_cat
classtree.pred.fit0.interact <- predict(fit0.interact, test_oh_wv_2012, type = "class") 
table(classtree.pred.fit0.interact, deathrate.test)
sum(diag(table(classtree.pred.fit0.interact, deathrate.test)))/36
```

#### ordnet
```{r}
pred_matrix.ordnet1 <- test_oh_wv_2012 %>%  #x is a matrix of predictors
  dplyr::select(est_death_rate_cat, pharmacy_num_ptt, most_dist_channel, dominance, median_income,
                political_aff, act_wt_person_county, perc_oxy, distr_num_ptt)
x.test.ordnet1<-model.matrix(est_death_rate_cat~., pred_matrix.ordnet1)
ordnet.pred<-predict(ordnet1, newx = x.test.ordnet1, whichLambda = NULL,
      criteria = "aic", type = "class")
deathrate.test <- as.character(test_oh_wv_2012$est_death_rate_cat)
no.cat.test<-str_replace(deathrate.test, "cat_", "")
no.cat.test<-as.numeric(no.cat.test)
table(ordnet.pred, no.cat.test)
z<-c(0, 0, 0, 0, 0)
table<-rbind(table(ordnet.pred, no.cat.test), z)
sum(diag(table))/36
```

#### prediction plots for fit.select

```{r}
#pharmacy no
pharm_num.test.ordnet1 = as.data.frame(pred_matrix.ordnet1) %>%
  mutate(most_dist_channel = "RETAIL PHARMACY", dominance = "Yes",
         median_income = 43194.13,
         political_aff="Republican",
         perc_oxy = 54.2, act_wt_person_county = 0.19294084, distr_num_ptt = 1.709)
summary(fit.select)
classprob_pharm_num  <- predict(fit.select, newdata = pharm_num.test.ordnet1, type = "probs", se.fit = TRUE)
# plotting
classprob_pharm_num_df = t(classprob_pharm_num) %>% 
  as.data.frame() %>%
  cumsum() %>% t() %>% as.data.frame() %>% 
  dplyr::select(-`cat_6`)
rownames(classprob_pharm_num_df) = NULL
colnames(classprob_pharm_num_df) = c("P[Y<=1]", "P[Y<=2]", "P[Y<=3]", "P[Y<=4]", "P[Y<=5]")
# plotting
classcumprob_pharm_num_df = as.data.frame(classprob_pharm_num_df) %>%
  cbind(pharm_num.test.ordnet1) %>%
  dplyr::select(pharmacy_num_ptt, `P[Y<=1]`:`P[Y<=5]`) %>%
  gather(key = "class", value = "probability", `P[Y<=1]`:`P[Y<=5]`) %>%
  mutate(class = as.factor(class))
  
ggplot(classcumprob_pharm_num_df, aes(x = pharmacy_num_ptt, y = probability)) +
    geom_line(aes(color = class, group = class)) +
    labs(title = "Cumulative Probabilities for Pharmacy No. per ten thousand people", 
         y = "P(Y<=j)",
         x= "Pharmacy Number PTT") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank())
```

```{r}
summary(fit.select)
# most_dist_channel
dom_channel.test.ordnet1 = as.data.frame(pred_matrix.ordnet1) %>%
  mutate(pharmacy_num_ptt = 3.038, dominance="Yes", median_income=43194.13,
         political_aff = "Republican",
         act_wt_person_county = 0.19294084,
         perc_oxy = 54.2, distr_num_ptt = 1.709)
classprob_most_dist_channel <- predict(fit.select, newdata = dom_channel.test.ordnet1, type = "probs")
# plotting
classprob_most_dist_channel_df = t(classprob_most_dist_channel) %>% 
  as.data.frame() %>%
  cumsum() %>% t() %>% as.data.frame() %>% 
  dplyr::select(-`cat_6`)
rownames(classprob_most_dist_channel_df) = NULL
colnames(classprob_most_dist_channel_df) = c("P[Y<=1]", "P[Y<=2]", "P[Y<=3]", "P[Y<=4]", "P[Y<=5]")
# plotting
classcumprob_most_dist_channel_df = as.data.frame(classprob_most_dist_channel_df) %>%
  cbind(dom_channel.test.ordnet1) %>%
  dplyr::select(most_dist_channel, `P[Y<=1]`:`P[Y<=5]`) %>%
  gather(key = "class", value = "probability", `P[Y<=1]`:`P[Y<=5]`) %>%
  mutate(class = as.factor(class),
         most_dist_channel = as.factor(most_dist_channel))
  
ggplot(classcumprob_most_dist_channel_df, aes(x = most_dist_channel, y = probability)) +
    geom_line(aes(color = class, group = class)) +
    labs(title = "Cumulative Probabilities for most common distributionn channel", 
         y = "P(Y<=j)",
         x= "most common distribution channel") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank())
```


```{r}
# dominance
dom_channel.test.ordnet1 = as.data.frame(pred_matrix.ordnet1) %>%
  mutate(pharmacy_num_ptt = 3.038, most_dist_channel = "RETAIL PHARMACY", median_income=43194.13,
         political_aff = "Republican",
         act_wt_person_county = 0.19294084,
         perc_oxy = 54.2, distr_num_ptt = 1.709)
classprob_dom <- predict(fit.select, newdata = dom_channel.test.ordnet1, type = "probs")
# plotting
classprob_dom_df = t(classprob_dom) %>% 
  as.data.frame() %>%
  cumsum() %>% t() %>% as.data.frame() %>% 
  dplyr::select(-`cat_6`)
rownames(classprob_dom_df) = NULL
colnames(classprob_dom_df) = c("P[Y<=1]", "P[Y<=2]", "P[Y<=3]", "P[Y<=4]", "P[Y<=5]")
# plotting
classcumprob_dom_df = as.data.frame(classprob_dom_df) %>%
  cbind(dom_channel.test.ordnet1) %>%
  dplyr::select(dominance, `P[Y<=1]`:`P[Y<=5]`) %>%
  gather(key = "class", value = "probability", `P[Y<=1]`:`P[Y<=5]`) %>%
  mutate(class = as.factor(class),
         dominance = as.factor(dominance))
  
ggplot(classcumprob_dom_df, aes(x = dominance, y = probability)) +
    geom_line(aes(color = class, group = class)) +
    labs(title = "Cumulative Probabilities for Market Dominance", 
         y = "P(Y<=j)",
         x= "Market Dominance") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank())
```

```{r}
# income
log_income.test.ordnet1 = as.data.frame(pred_matrix.ordnet1) %>%
  mutate(pharmacy_num_ptt = 3.038, most_dist_channel = "RETAIL PHARMACY", dominance = "Yes",
         political_aff = "Republican",
         act_wt_person_county = 0.19294084,
         perc_oxy = 54.2, distr_num_ptt = 1.709)
classprob_log_income <- predict(fit.select, newdata = log_income.test.ordnet1, type = "probs")
# plotting
classprob_log_income_df = t(classprob_log_income) %>% 
  as.data.frame() %>%
  cumsum() %>% t() %>% as.data.frame() %>% 
  dplyr::select(-`cat_6`)
rownames(classprob_log_income_df) = NULL
colnames(classprob_log_income_df) = c("P[Y<=1]", "P[Y<=2]", "P[Y<=3]", "P[Y<=4]", "P[Y<=5]")
# plotting
classcumprob_log_income_df = as.data.frame(classprob_log_income_df) %>%
  cbind(log_income.test.ordnet1) %>%
  dplyr::select(median_income, `P[Y<=1]`:`P[Y<=5]`) %>%
  gather(key = "class", value = "probability", `P[Y<=1]`:`P[Y<=5]`) %>%
  mutate(class = as.factor(class))
  
ggplot(classcumprob_log_income_df, aes(x = median_income, y = probability)) +
    geom_line(aes(color = class, group = class)) +
    labs(title = "Cumulative Probabilities for median income", 
         y = "P(Y<=j)",
         x= "Median Income") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank())
```


```{r}
# political_aff
polaff.test.ordnet1 = as.data.frame(pred_matrix.ordnet1) %>%
    mutate(pharmacy_num_ptt = 3.038, most_dist_channel = "RETAIL PHARMACY", dominance = "Yes",
         median_income = 43194.13,
         act_wt_person_county = 0.19294084,
         perc_oxy = 54.2, distr_num_ptt = 1.709)
classprob_polaff <- predict(fit.select, newdata = polaff.test.ordnet1, type = "probs")
# plotting
classprob_polaff_df = t(classprob_polaff) %>% 
  as.data.frame() %>%
  cumsum() %>% t() %>% as.data.frame() %>% 
  dplyr::select(-`cat_6`)
rownames(classprob_polaff_df) = NULL
colnames(classprob_polaff_df) = c("P[Y<=1]", "P[Y<=2]", "P[Y<=3]", "P[Y<=4]", "P[Y<=5]")
# plotting
classcumprob_polaff_df = as.data.frame(classprob_polaff_df) %>%
  cbind(polaff.test.ordnet1) %>%
  dplyr::select(political_aff, `P[Y<=1]`:`P[Y<=5]`) %>%
  gather(key = "class", value = "probability", `P[Y<=1]`:`P[Y<=5]`) %>%
  mutate(class = as.factor(class),
         political_aff = as.factor(political_aff))
  
ggplot(classcumprob_polaff_df, aes(x = political_aff, y = probability)) +
    geom_line(aes(color = class, group = class)) +
    labs(title = "Cumulative Probabilities for Political Affiliation", 
         y = "P(Y<=j)",
         x= "Political Affiliation") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank())
```




```{r}
# act_wt_person_county
act_wt.test.ordnet1 = as.data.frame(pred_matrix.ordnet1) %>%
  mutate(pharmacy_num_ptt = 3.038, most_dist_channel = "RETAIL PHARMACY", dominance = "Yes",
         median_income = 43194.13,
         political_aff="Republican",
         perc_oxy = 54.2, distr_num_ptt = 1.709)
classprob_act_wt <- predict(fit.select, newdata = act_wt.test.ordnet1, type = "probs")
# plotting
classprob_act_wt_df = t(classprob_act_wt) %>% 
  as.data.frame() %>%
  cumsum() %>% t() %>% as.data.frame() %>% 
  dplyr::select(-`cat_6`)
rownames(classprob_act_wt_df) = NULL
colnames(classprob_act_wt_df) = c("P[Y<=1]", "P[Y<=2]", "P[Y<=3]", "P[Y<=4]", "P[Y<=5]")
# plotting
classcumprob_act_wt_df = as.data.frame(classprob_act_wt_df) %>%
  cbind(act_wt.test.ordnet1) %>%
  dplyr::select(act_wt_person_county, `P[Y<=1]`:`P[Y<=5]`) %>%
  gather(key = "class", value = "probability", `P[Y<=1]`:`P[Y<=5]`) %>%
  mutate(class = as.factor(class))
  
ggplot(classcumprob_act_wt_df, aes(x = act_wt_person_county, y = probability)) +
    geom_line(aes(color = class, group = class)) +
    labs(title = "Cumulative Probabilities for Active Weight Per Person", 
         y = "P(Y<=j)",
         x= "Active Drug Weight Per Person") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank())
```


```{r}
# perc_oxy --> NOT SIGNIFICANT IN CURRENT MODEL
perc_oxy.test.ordnet1 = as.data.frame(pred_matrix.ordnet1) %>%
  mutate(pharmacy_num_ptt = 3.038, most_dist_channel = "RETAIL PHARMACY", dominance = "Yes",
         median_income = 43194.13,
         political_aff="Republican",
         act_wt_person_county = 0.19294084, distr_num_ptt = 1.709)
classprob_perc_oxy <- predict(fit.select, newdata = perc_oxy.test.ordnet1, type = "probs")
# plotting
classprob_perc_oxy_df = t(classprob_perc_oxy) %>% 
  as.data.frame() %>%
  cumsum() %>% t() %>% as.data.frame() %>% 
  dplyr::select(-`cat_6`)
rownames(classprob_perc_oxy_df) = NULL
colnames(classprob_perc_oxy_df) = c("P[Y<=1]", "P[Y<=2]", "P[Y<=3]", "P[Y<=4]", "P[Y<=5]")
# plotting
classcumprob_perc_oxy_df = as.data.frame(classprob_perc_oxy_df) %>%
  cbind(perc_oxy.test.ordnet1) %>%
  dplyr::select(perc_oxy, `P[Y<=1]`:`P[Y<=5]`) %>%
  gather(key = "class", value = "probability", `P[Y<=1]`:`P[Y<=5]`) %>%
  mutate(class = as.factor(class))
  
ggplot(classcumprob_perc_oxy_df, aes(x = perc_oxy, y = probability)) +
    geom_line(aes(color = class, group = class)) +
    labs(title = "Cumulative Probabilities for Percentage of Oxycodone", 
         y = "P(Y<=j)",
         x= "Percentage of Oxycodone") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank())
```

```{r}
# distr_num_ptt
distr_num.test.ordnet1 = as.data.frame(pred_matrix.ordnet1) %>%
  mutate(pharmacy_num_ptt = 3.038, most_dist_channel = "RETAIL PHARMACY", dominance = "Yes",
         median_income = 43194.13,
         political_aff="Republican",
         act_wt_person_county = 0.19294084)
classprob_distr_num  <- polr.predict(fit.select, newdata = distr_num.test.ordnet1, type = "probs", conf.int=0.95)
# plotting
classprob_distr_num_df = t(classprob_distr_num) %>% 
  as.data.frame() %>%
  cumsum() %>% t() %>% as.data.frame() %>% 
  dplyr::select(-`cat_6`)
rownames(classprob_distr_num_df) = NULL
colnames(classprob_distr_num_df) = c("P[Y<=1]", "P[Y<=2]", "P[Y<=3]", "P[Y<=4]", "P[Y<=5]")
# plotting
classcumprob_distr_num_df = as.data.frame(classprob_distr_num_df) %>%
  cbind(distr_num.test.ordnet1) %>%
  dplyr::select(distr_num_ptt, `P[Y<=1]`:`P[Y<=5]`) %>%
  gather(key = "class", value = "probability", `P[Y<=1]`:`P[Y<=5]`) %>%
  mutate(class = as.factor(class))
  
ggplot(classcumprob_distr_num_df, aes(x = distr_num_ptt, y = probability)) +
    geom_line(aes(color = class, group = class)) +
    labs(title = "Cumulative Probabilities for Distributor Number PTT", 
         y = "P(Y<=j)",
         x= "Distributor Number PTT") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank())
```

#### interaction plots for fit.select

```{r}
## number of pharmacies and political affilition
# Republican
pharm_num.test.ordnet1_rep = as.data.frame(pred_matrix.ordnet1) %>%
  mutate(most_dist_channel = "RETAIL PHARMACY", dominance = "Yes",
         median_income = 43194.13,
         political_aff="Republican",
         perc_oxy = 54.2, act_wt_person_county = 0.19294084, distr_num_ptt = 1.709)

classprob_pharm_num_rep  <- predict(fit.select, newdata = pharm_num.test.ordnet1_rep, type = "probs", se.fit = TRUE)
# plotting
classprob_pharm_num_rep_df = t(classprob_pharm_num_rep) %>% 
  as.data.frame() %>%
  cumsum() %>% t() %>% as.data.frame() %>% 
  dplyr::select(-`cat_6`)
rownames(classprob_pharm_num_rep_df) = NULL
colnames(classprob_pharm_num_rep_df) = c("P[Y<=1]", "P[Y<=2]", "P[Y<=3]", "P[Y<=4]", "P[Y<=5]")
# plotting
classcumprob_pharm_num_rep_df = as.data.frame(classprob_pharm_num_rep_df) %>%
  cbind(pharm_num.test.ordnet1_rep) %>%
  dplyr::select(pharmacy_num_ptt, `P[Y<=1]`:`P[Y<=5]`) %>%
  gather(key = "class", value = "probability", `P[Y<=1]`:`P[Y<=5]`) %>%
  mutate(class = as.factor(class))
  
num_pharm_rep_p = ggplot(classcumprob_pharm_num_rep_df, aes(x = pharmacy_num_ptt, y = probability)) +
    geom_line(aes(color = class, group = class)) +
    labs(title = "Republican", 
         y = "P(Y<=j)",
         x= "Pharmacy Number PTT") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank())

# Democrat
pharm_num.test.ordnet1_dem = as.data.frame(pred_matrix.ordnet1) %>%
  mutate(most_dist_channel = "RETAIL PHARMACY", dominance = "Yes",
         median_income = 43194.13,
         political_aff="Democrat",
         perc_oxy = 54.2, act_wt_person_county = 0.19294084, distr_num_ptt = 1.709)

classprob_pharm_num_dem  <- predict(fit.select, newdata = pharm_num.test.ordnet1_dem, type = "probs", se.fit = TRUE)
# plotting
classprob_pharm_num_dem_df = t(classprob_pharm_num_dem) %>% 
  as.data.frame() %>%
  cumsum() %>% t() %>% as.data.frame() %>% 
  dplyr::select(-`cat_6`)
rownames(classprob_pharm_num_dem_df) = NULL
colnames(classprob_pharm_num_dem_df) = c("P[Y<=1]", "P[Y<=2]", "P[Y<=3]", "P[Y<=4]", "P[Y<=5]")
# plotting
classcumprob_pharm_num_dem_df = as.data.frame(classprob_pharm_num_dem_df) %>%
  cbind(pharm_num.test.ordnet1_dem) %>%
  dplyr::select(pharmacy_num_ptt, `P[Y<=1]`:`P[Y<=5]`) %>%
  gather(key = "class", value = "probability", `P[Y<=1]`:`P[Y<=5]`) %>%
  mutate(class = as.factor(class))
  
num_pharm_dem_p = ggplot(classcumprob_pharm_num_dem_df, aes(x = pharmacy_num_ptt, y = probability)) +
    geom_line(aes(color = class, group = class)) +
    labs(title = "Democrat",
         y = "P(Y<=j)",
         x= "Pharmacy Number PTT") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank(),
          legend.position = "none")

num_pharm_rep_p + num_pharm_dem_p
# plot_grid(num_pharm_rep_p, num_pharm_dem_p, axis = "r", align = "v")

# probability of falling below a category decreases faster for democrats. is
# significant? because our dataset is small.
```

```{r}
## distribution channel and income

# RETAIL PHARMACRY
income.test.ordnet1_rp = as.data.frame(pred_matrix.ordnet1) %>%
  mutate(most_dist_channel = "RETAIL PHARMACY", dominance = "Yes",
         pharmacy_num_ptt = 3.038,
         political_aff="Republican",
         perc_oxy = 54.2, act_wt_person_county = 0.19294084, distr_num_ptt = 1.709)

classprob_income_rp  <- predict(fit.select, newdata = income.test.ordnet1_rp, type = "probs", se.fit = TRUE)
# plotting
classprob_income_rp_df = t(classprob_income_rp) %>% 
  as.data.frame() %>%
  cumsum() %>% t() %>% as.data.frame() %>% 
  dplyr::select(-`cat_6`)
rownames(classprob_income_rp_df) = NULL
colnames(classprob_income_rp_df) = c("P[Y<=1]", "P[Y<=2]", "P[Y<=3]", "P[Y<=4]", "P[Y<=5]")
# plotting
classcumprob_income_rp_df = as.data.frame(classprob_income_rp_df) %>%
  cbind(income.test.ordnet1_rp) %>%
  dplyr::select(median_income, `P[Y<=1]`:`P[Y<=5]`) %>%
  gather(key = "class", value = "probability", `P[Y<=1]`:`P[Y<=5]`) %>%
  mutate(class = as.factor(class))
  
income_rp_p = ggplot(classcumprob_income_rp_df, aes(x = median_income, y = probability)) +
    geom_line(aes(color = class, group = class)) +
    labs(title = "Retail Pharmacy", 
         y = "P(Y<=j)",
         x= "Median Income") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank())

# RETAIL PHARMACRY
income.test.ordnet1_cp = as.data.frame(pred_matrix.ordnet1) %>%
  mutate(most_dist_channel = "CHAIN PHARMACY", dominance = "Yes",
         pharmacy_num_ptt = 3.038,
         political_aff="Republican",
         perc_oxy = 54.2, act_wt_person_county = 0.19294084, distr_num_ptt = 1.709)

classprob_income_cp  <- predict(fit.select, newdata = income.test.ordnet1_cp, type = "probs", se.fit = TRUE)
# plotting
classprob_income_cp_df = t(classprob_income_cp) %>% 
  as.data.frame() %>%
  cumsum() %>% t() %>% as.data.frame() %>% 
  dplyr::select(-`cat_6`)
rownames(classprob_income_cp_df) = NULL
colnames(classprob_income_cp_df) = c("P[Y<=1]", "P[Y<=2]", "P[Y<=3]", "P[Y<=4]", "P[Y<=5]")
# plotting
classcumprob_income_cp_df = as.data.frame(classprob_income_cp_df) %>%
  cbind(income.test.ordnet1_cp) %>%
  dplyr::select(median_income, `P[Y<=1]`:`P[Y<=5]`) %>%
  gather(key = "class", value = "probability", `P[Y<=1]`:`P[Y<=5]`) %>%
  mutate(class = as.factor(class))
  
income_cp_p = ggplot(classcumprob_income_cp_df, aes(x = median_income, y = probability)) +
    geom_line(aes(color = class, group = class)) +
    labs(title = "Chain Pharmacy", 
         y = "P(Y<=j)",
         x= "Median Income") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank(),
          legend.position = "none")

income_rp_p + income_cp_p
# plot_grid(income_rp_p, income_cp_p, axis = "r", align = "v")
```

```{r}
## pharmacy number and log median income
# range of pharmacy number ptt: 0.928 4.850

# fixing pharmacy number at = 1
income.test.ordnet1_1 = as.data.frame(pred_matrix.ordnet1) %>%
  mutate(most_dist_channel = "RETAIL PHARMACY", dominance = "Yes",
         pharmacy_num_ptt = 1,
         political_aff="Republican",
         perc_oxy = 54.2, act_wt_person_county = 0.19294084, distr_num_ptt = 1.709)

classprob_income_1  <- predict(fit.select, newdata = income.test.ordnet1_1, type = "probs", se.fit = TRUE)
# plotting
classprob_income_1_df = t(classprob_income_1) %>% 
  as.data.frame() %>%
  cumsum() %>% t() %>% as.data.frame() %>% 
  dplyr::select(-`cat_6`)
rownames(classprob_income_1_df) = NULL
colnames(classprob_income_1_df) = c("P[Y<=1]", "P[Y<=2]", "P[Y<=3]", "P[Y<=4]", "P[Y<=5]")
# plotting
classcumprob_income_1_df = as.data.frame(classprob_income_1_df) %>%
  cbind(income.test.ordnet1_1) %>%
  dplyr::select(median_income, `P[Y<=1]`:`P[Y<=5]`) %>%
  gather(key = "class", value = "probability", `P[Y<=1]`:`P[Y<=5]`) %>%
  mutate(class = as.factor(class))
  
income_1_p = ggplot(classcumprob_income_1_df, aes(x = median_income, y = probability)) +
    geom_line(aes(color = class, group = class)) +
    labs(title = "Pharmacy Number PTT = 1", 
         y = "P(Y<=j)",
         x= "Median Income") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank())

# fixing pharmacy number at = 4
income.test.ordnet1_4 = as.data.frame(pred_matrix.ordnet1) %>%
  mutate(most_dist_channel = "CHAIN PHARMACY", dominance = "Yes",
         pharmacy_num_ptt = 4,
         political_aff="Republican",
         perc_oxy = 54.2, act_wt_person_county = 0.19294084, distr_num_ptt = 1.709)

classprob_income_4  <- predict(fit.select, newdata = income.test.ordnet1_4, type = "probs", se.fit = TRUE)
# plotting
classprob_income_4_df = t(classprob_income_4) %>% 
  as.data.frame() %>%
  cumsum() %>% t() %>% as.data.frame() %>% 
  dplyr::select(-`cat_6`)
rownames(classprob_income_4_df) = NULL
colnames(classprob_income_4_df) = c("P[Y<=1]", "P[Y<=2]", "P[Y<=3]", "P[Y<=4]", "P[Y<=5]")
# plotting
classcumprob_income_4_df = as.data.frame(classprob_income_4_df) %>%
  cbind(income.test.ordnet1_4) %>%
  dplyr::select(median_income, `P[Y<=1]`:`P[Y<=5]`) %>%
  gather(key = "class", value = "probability", `P[Y<=1]`:`P[Y<=5]`) %>%
  mutate(class = as.factor(class))
  
income_4_p = ggplot(classcumprob_income_4_df, aes(x = median_income, y = probability)) +
    geom_line(aes(color = class, group = class)) +
    labs(title = "Pharmacy Number PTT = 4", 
         y = "P(Y<=j)",
         x= "Median Income") +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(face = "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          legend.title = element_blank(),
          legend.position = "none")

income_1_p + income_4_p
# plot_grid(income_1_p, income_4_p, axis = "r", align = "v")
```

